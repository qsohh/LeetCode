## Find Loyal Customers

鉴于今天的每日一题这么简单，就做个数据库补充一下吧。

```python
import pandas as pd

def find_loyal_customers(df: pd.DataFrame) -> pd.DataFrame:
    df["transaction_date"] = pd.to_datetime(df["transaction_date"])
    agg = (df.groupby("customer_id").agg(
        purchase_count=("transaction_type", lambda x: (x=="purchase").sum()), 
        refund_rate=("transaction_type", lambda x: (x=="refund").sum()/len(x)),
        active_period=("transaction_date", lambda x: (x.max() - x.min()).days)
        )).reset_index()
    res = agg[(agg["purchase_count"] >= 3) & (agg["refund_rate"] < 0.2) & (agg["active_period"] >= 30)]
    return res[["customer_id"]]
```

```postgreSQL
SELECT customer_id
FROM customer_transactions
GROUP BY customer_id
HAVING COUNT(*) FILTER (WHERE transaction_type = 'purchase') >= 3
   AND COUNT(*) FILTER (WHERE transaction_type = 'refund')::numeric / COUNT(*) < 0.2
   AND (MAX(transaction_date) - MIN(transaction_date)) >= 30
ORDER BY customer_id ASC;
```